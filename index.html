<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Passaportes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#0077ff;--bg:#f7f9fc;--card:#fff;--border:#e0e6ed}
    *{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,sans-serif}
    body{background:var(--bg);color:#222;padding:1rem;max-width:540px;margin:auto}
    h1{font-size:1.8rem;text-align:center;color:var(--primary);margin-bottom:.5rem}
    h2{font-size:1.2rem;text-align:center;margin-bottom:.8rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    label{display:block;margin-top:.8rem;font-weight:600}
    input,select{width:100%;padding:.6rem .7rem;border:1px solid var(--border);border-radius:8px;margin-top:.3rem;font-size:1rem}
    button{display:block;width:100%;margin-top:1rem;padding:.8rem;border:none;border-radius:8px;background:var(--primary);color:#fff;font-size:1rem;cursor:pointer;transition:filter .2s}
    button:hover{filter:brightness(1.08)}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{border:1px solid var(--border);padding:.4rem;text-align:center}
    th{background:var(--primary);color:#fff}
    #toast{position:fixed;top:1rem;right:1rem;min-width:220px;padding:.8rem;border-radius:8px;background:#333;color:#fff;opacity:0;pointer-events:none;transition:opacity .35s;z-index:9999}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>Controle de Passaportes</h1>
  <h2>Total de drinks distribu√≠dos: <span id="drinkTotal">0</span></h2>

  <!-- üîç Busca -->
  <div class="card" id="buscaCard">
    <label>Procurar participante</label>
    <input id="search" placeholder="Digite o nome completo‚Ä¶" autocomplete="off">
    <div id="searchResult" style="margin-top:.6rem;font-weight:600"></div>
    <button id="btnNovo" class="hidden">Registrar novo participante</button>
  </div>

  <!-- üìù Formul√°rio -->
  <div class="card hidden" id="formCard">
    <form id="form">
      <label>Nome completo
        <input id="nome" required autocomplete="off">
      </label>
      <label>Turma (opcional p/ convidados)
        <input id="turma" autocomplete="off">
      </label>
      <label>Categoria
        <select id="categoria">
          <option value="Apresentador">Apresentador</option>
          <option value="Visitante">Visitante</option>
          <option value="Convidado">Convidado</option>
        </select>
      </label>
      <div style="margin-top:.5rem;font-size:.9rem">Drinks permitidos: <span id="drinksInfo">2</span></div>
      <button type="submit">Salvar participante</button>
    </form>
  </div>

  <!-- ‚öôÔ∏è A√ß√µes sobre participante existente -->
  <div class="card hidden" id="acoesCard">
    <div id="infoSelecionado" style="font-weight:600"></div>
    <button id="btnToken">Adicionar token 2 drinks (R$15)</button>
    <button id="btnCracha">Imprimir crach√°</button>
  </div>

  <!-- üìä √öltimos registros -->
  <div class="card">
    <h3 style="margin-bottom:.5rem">√öltimos registros</h3>
    <table id="log"><thead><tr><th>Nome</th><th>C</th><th>üçπ</th><th>Token</th></tr></thead><tbody></tbody></table>
    <button id="btnCsv" style="margin-top:1rem;background:#13b813">Exportar CSV</button>
  </div>

  <div id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script>
  /* -------- 1. CONFIG FIREBASE -------- */
  const firebaseConfig={
    apiKey:"AIzaSyAMcHp33IW5SC0dWlCUyPq9wpQacARGp0w",
    authDomain:"project-day-cna.firebaseapp.com",
    projectId:"project-day-cna",
    storageBucket:"project-day-cna.appspot.com",
    messagingSenderId:"760089907322",
    appId:"1:760089907322:web:51935ba6142acacf3b2bc3",
    measurementId:"G-WDLSR8YTK4"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();

  /* -------- 2. HELPERS -------- */
  const slug=s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]+/g,'').trim().replace(/\s+/g,'-');
  const drinksByCat=c=>c==='Apresentador'?2:c==='Visitante'?1:0;
  const toast=m=>{const t=document.getElementById('toast');t.textContent=m;t.style.opacity=1;clearTimeout(t._t);t._t=setTimeout(()=>t.style.opacity=0,3000)};

  /* -------- 3. UI refs -------- */
  const ui={
   search:document.getElementById('search'),result:document.getElementById('searchResult'),btnNovo:document.getElementById('btnNovo'),
   formCard:document.getElementById('formCard'),form:document.getElementById('form'),nome:document.getElementById('nome'),turma:document.getElementById('turma'),categoria:document.getElementById('categoria'),drinksInfo:document.getElementById('drinksInfo'),
   acoesCard:document.getElementById('acoesCard'),infoSel:document.getElementById('infoSelecionado'),btnToken:document.getElementById('btnToken'),btnCracha:document.getElementById('btnCracha'),
   logBody:document.querySelector('#log tbody'),drinkTotal:document.getElementById('drinkTotal'),btnCsv:document.getElementById('btnCsv')};

  ui.categoria.onchange=()=>ui.drinksInfo.textContent=drinksByCat(ui.categoria.value);

  let participanteSel=null; // guarda docId do participante em foco

  /* -------- 4. BUSCA -------- */
  ui.search.addEventListener('keyup',async e=>{
    const q=slug(e.target.value);
    ui.btnNovo.classList.add('hidden');ui.formCard.classList.add('hidden');ui.acoesCard.classList.add('hidden');participanteSel=null;
    if(q.length<3){ui.result.textContent='';return;}
    try{
      const doc=await db.collection('pessoas').doc(q).get();
      if(doc.exists){
        const d=doc.data();participanteSel=q;
        ui.result.innerHTML=`‚úÖ <b>${d.nome}</b> ‚Äì ${d.drinks} drinks ${d.token?'+ 2 token':''}`;
        ui.infoSel.textContent=`Selecionado: ${d.nome} | Drinks: ${d.drinks} ${d.token?'(+token)':''}`;
        ui.acoesCard.classList.remove('hidden');
        ui.btnToken.textContent=d.token?'Token j√° adicionado':'Adicionar token 2 drinks (R$15)';
      }else{
        ui.result.textContent='üîé N√£o encontrado.';
        ui.btnNovo.classList.remove('hidden');
      }
    }catch(err){console.error(err);toast('Erro na busca')}
  });

  /* -------- 5. REGISTRAR NOVO -------- */
  ui.btnNovo.onclick=()=>{
    ui.formCard.classList.remove('hidden');
    ui.nome.value=ui.search.value.trim();
    ui.nome.focus();
  }
  ui.form.addEventListener('submit',async ev=>{
    ev.preventDefault();
    const nome=ui.nome.value.trim();if(!nome){toast('Preencha o nome');return;}
    const id=slug(nome);const data={nome,turma:ui.turma.value.trim(),categoria:ui.categoria.value,drinks:drinksByCat(ui.categoria.value),token:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()};
    try{
      await db.collection('pessoas').doc(id).set(data,{merge:true});
      toast('Salvo!');
      ui.form.reset();ui.formCard.classList.add('hidden');ui.search.value='';ui.result.textContent='';renderLog();
    }catch(err){console.error(err);toast('Erro ao salvar')}
  });

  /* -------- 6. A√á√ïES: TOKEN & CRACH√Å -------- */
  ui.btnToken.onclick=async()=>{
    if(!participanteSel)return;
    try{
      const ref=db.collection('pessoas').doc(participanteSel);const snap=await ref.get();const d=snap.data();
      if(d.token){toast('Token j√° registrado');return;}
      await ref.update({token:true});toast('Token adicionado!');ui.btnToken.textContent='Token j√° adicionado';renderLog();
    }catch(err){console.error(err);toast('Erro ao adicionar token')}
  }
  ui.btnCracha.onclick=async()=>{
    if(!participanteSel)return;const snap=await db.collection('pessoas').doc(participanteSel).get();const d=snap.data();
    const w=window.open('','_blank','width=300,height=200');w.document.write(`<style>@media print{@page{size:credit-card}}</style><h2 style="font-family:Poppins">${d.nome}</h2><p>${d.categoria} ‚Äì ${d.drinks} drinks${d.token?'+token':''}</p>`);w.print();w.close();
  }

  /* -------- 7. LOG & DRINK COUNTER -------- */
  async function renderLog(){
    try{
      const snap=await db.collection('pessoas').orderBy('timestamp','desc').limit(10).get();
      ui.logBody.innerHTML=snap.docs.map(d=>{const v=d.data();return `<tr><td>${v.nome}</td><td>${v.categoria[0]}</td><td>${v.drinks}</td><td>${v.token?'‚úîÔ∏è':''}</td></tr>`}).join('');
      // total
      const all=await db.collection('pessoas').get();let total=0;all.forEach(doc=>{const v=doc.data();total+=v.drinks+(v.token?2:0)});ui.drinkTotal.textContent=total;
    }catch(err){console.error(err);toast('Erro log')}
  }
  renderLog();

  /* -------- 8. EXPORTA CSV -------- */
  ui.btnCsv.onclick=async()=>{
    try{
      const snap=await db.collection('pessoas').get();let csv='Nome,Turma,Categoria,Drinks,Token\n';
      snap.forEach(doc=>{const v=doc.data();csv+=`${v.nome},${v.turma},${v.categoria},${v.drinks},${v.token}\n`});
      const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='passaportes.csv';a.click();URL.revokeObjectURL(url);
    }catch(err){console.error(err);toast('Erro CSV')}
  }
  </script>
</body>
</html>
